<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tha lỗi cho anh nhé?</title>
    <style>
      :root{
        --bg1:#0b1220;
        --bg2:#121a2c;
        --card:#0f1729cc;
        --text:#e8eefc;
        --muted:#b9c4e6;
        --green:#22c55e;
        --red:#ef4444;
        --blue:#3b82f6;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
        color:var(--text);
        background: radial-gradient(1200px 800px at 20% 20%, #1a2b55 0%, transparent 60%),
                    radial-gradient(900px 700px at 90% 30%, #2a1b52 0%, transparent 55%),
                    linear-gradient(160deg, var(--bg1), var(--bg2));
        overflow:hidden;
      }
      .wrap{
        height:100%;
        display:grid;
        place-items:center;
        padding:20px;
      }
      .card{
        width:min(880px, 96vw);
        background: linear-gradient(180deg, #111b33cc, #0a1022cc);
        border:1px solid #2a3a66;
        box-shadow: 0 30px 80px rgba(0,0,0,.45);
        border-radius:24px;
        padding:24px;
        position:relative;
        backdrop-filter: blur(10px);
      }
      .grid{
        display:grid;
        grid-template-columns: 1.2fr 1fr;
        gap:20px;
        align-items:center;
      }
      @media (max-width: 780px){
        .grid{grid-template-columns:1fr}
        body{overflow:auto}
      }
      .title{
        font-size: clamp(22px, 3vw, 34px);
        line-height:1.15;
        margin:0 0 10px 0;
        letter-spacing:.2px;
      }
      .subtitle{
        margin:0 0 18px 0;
        color:var(--muted);
        font-size: 15px;
      }
      .gif{
        width:100%;
        aspect-ratio: 16 / 10;
        border-radius:18px;
        overflow:hidden;
        border:1px solid #2a3a66;
        background:#0b1020;
        display:grid;
        place-items:center;
      }
      .gif img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .actions{
        display:flex;
        gap:12px;
        flex-wrap:wrap;
        align-items:center;
        margin-top:14px;
      }
      button{
        border:0;
        padding:12px 18px;
        border-radius:14px;
        font-weight:700;
        cursor:pointer;
        font-size:16px;
        transition: transform .08s ease, filter .2s ease;
        user-select:none;
        -webkit-tap-highlight-color: transparent;
      }
      button:active{transform: scale(.98)}
      .yes{
        background: linear-gradient(180deg, #34d399, #16a34a);
        color:#062012;
      }
      .no{
        background: linear-gradient(180deg, #fb7185, #ef4444);
        color:#2a040a;
        position:fixed;
        left: 58%;
        top: 68%;
        z-index: 5;
      }
      .hint{
        margin-top:10px;
        color: var(--muted);
        font-size: 13px;
      }
      .toast{
        position:fixed;
        left:50%;
        transform: translateX(-50%);
        bottom:16px;
        background: rgba(15, 23, 41, .9);
        border:1px solid #2a3a66;
        color: var(--text);
        padding:10px 14px;
        border-radius: 999px;
        font-size: 14px;
        opacity:0;
        pointer-events:none;
        transition: opacity .22s ease, transform .22s ease;
      }
      .toast.show{
        opacity:1;
        transform: translateX(-50%) translateY(-6px);
      }
      .success{
        display:none;
      }
      .success .big{
        font-size: clamp(26px, 3.4vw, 44px);
        margin: 6px 0 10px 0;
      }
      .success .msg{
        margin:0;
        color:var(--muted);
        font-size: 15px;
        line-height:1.6;
      }
      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 12px;
        border-radius: 999px;
        border:1px solid #2a3a66;
        background: rgba(10, 16, 34, .55);
        color: var(--muted);
        font-size: 13px;
        margin-top: 14px;
      }
      canvas#fw{
        position:fixed;
        inset:0;
        width:100%;
        height:100%;
        display:none;
        pointer-events:none;
      }
      .blocker{
        position:fixed;
        inset:0;
        display:none;
        place-items:center;
        background: rgba(0,0,0,.55);
        padding:18px;
      }
      .modal{
        width:min(520px, 92vw);
        border-radius:18px;
        background: rgba(15, 23, 41, .95);
        border:1px solid #2a3a66;
        padding:16px;
        box-shadow: 0 30px 70px rgba(0,0,0,.55);
      }
      .modal h3{margin:0 0 8px 0}
      .modal p{margin:0 0 12px 0; color:var(--muted); line-height:1.5}
      .modal .row{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
      .modal .row button{
        padding:10px 14px;
        border-radius:12px;
        font-size:14px;
      }
      .btn-keep{background: linear-gradient(180deg, #60a5fa, #3b82f6); color:#071a33}
      .btn-ok{background: linear-gradient(180deg, #34d399, #16a34a); color:#062012}
      .credit{
        position:fixed;
        right:14px;
        top:12px;
        color:#92a2d5;
        font-size: 12px;
        opacity:.75;
        user-select:none;
      }
    </style>
  </head>
  <body>
    <div class="credit">Made with sincerity</div>
    <canvas id="fw"></canvas>

    <div class="toast" id="toast">Hụt rồi nhé!</div>

    <div class="blocker" id="blocker" role="dialog" aria-modal="true">
      <div class="modal">
        <h3>Chưa trả lời mà đã định chạy đi đâu?</h3>
        <p>Ở lại chút xíu nha… anh hứa ngoan.</p>
        <div class="row">
          <button class="btn-keep" id="stayBtn" type="button">Ở lại</button>
          <button class="btn-ok" id="okBtn" type="button">Thôi được…</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="card" id="card">
        <section class="grid" id="screenAsk">
          <div>
            <h1 class="title" id="questionText">Em hết giận anh/tha lỗi cho anh nhé?</h1>
            <p class="subtitle" id="subText">Anh biết anh sai. Cho anh cơ hội sửa sai nha.</p>
            <div class="actions">
              <button class="yes" id="yesBtn" type="button">Có</button>
            </div>
            <div class="hint" id="hint">Gợi ý: nút đỏ “Không” hơi… nhát.</div>
          </div>
          <div class="gif">
            <img
              id="cryGif"
              alt="mếu máo"
              src="https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif"
            />
          </div>
          <button class="no" id="noBtn" type="button">Không</button>
        </section>

        <section class="success" id="screenYes">
          <div class="grid">
            <div>
              <div class="pill">Đã nhận được “Có” rồi nè</div>
              <h2 class="big" id="thanksTitle">Yêu em nhiều. Cảm ơn em đã tha lỗi.</h2>
              <p class="msg" id="thanksBody">
                Anh sẽ bù đắp bằng hành động. Từ giờ anh sẽ lắng nghe nhiều hơn, bớt cứng đầu hơn,
                và thương em nhiều hơn mỗi ngày.
              </p>
              <div class="actions" style="margin-top:16px">
                <button class="yes" id="replayBtn" type="button">Xem pháo hoa nữa</button>
              </div>
              <div class="hint">Nếu nhạc không tự phát, chạm nút “Xem pháo hoa nữa”.</div>
            </div>
            <div class="gif">
              <img
                id="happyGif"
                alt="vui vẻ"
                src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif"
              />
            </div>
          </div>
        </section>
      </div>
    </div>

    <audio id="bgm" preload="auto" loop>
      <source src="" type="audio/mpeg" />
    </audio>

    <script>
      const CONFIG = {
        question: "Em hết giận anh/tha lỗi cho anh nhé?",
        subtitle: "Anh biết anh sai. Cho anh cơ hội sửa sai nha.",
        cryGifUrl: "https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif",
        happyGifUrl: "https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif",
        bgmMp3Url: "",
        tauntMessages: ["Hụt rồi nhé!", "Năn nỉ đó...", "Bấm nút xanh bên kia kìa!", "Ơ kìa… đừng giận nữa mà."],
        thanksTitle: "Yêu em nhiều. Cảm ơn em đã tha lỗi.",
        thanksBody:
          "Anh sẽ bù đắp bằng hành động. Từ giờ anh sẽ lắng nghe nhiều hơn, bớt cứng đầu hơn, và thương em nhiều hơn mỗi ngày.",
      };

      const $ = (s) => document.querySelector(s);
      const screenAsk = $("#screenAsk");
      const screenYes = $("#screenYes");
      const noBtn = $("#noBtn");
      const yesBtn = $("#yesBtn");
      const replayBtn = $("#replayBtn");
      const toast = $("#toast");
      const fw = $("#fw");
      const card = $("#card");
      const blocker = $("#blocker");
      const stayBtn = $("#stayBtn");
      const okBtn = $("#okBtn");
      const bgm = $("#bgm");

      $("#questionText").textContent = CONFIG.question;
      $("#subText").textContent = CONFIG.subtitle;
      $("#cryGif").src = CONFIG.cryGifUrl;
      $("#happyGif").src = CONFIG.happyGifUrl;
      $("#thanksTitle").textContent = CONFIG.thanksTitle;
      $("#thanksBody").textContent = CONFIG.thanksBody;

      if (CONFIG.bgmMp3Url) {
        bgm.querySelector("source").src = CONFIG.bgmMp3Url;
        bgm.load();
      }

      let rejectCount = 0;
      let toastTimer = null;
      let allowExit = false;

      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toast.classList.remove("show"), 900);
      }

      function ping() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const ctx = new AudioCtx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 880 + Math.random() * 220;
          g.gain.value = 0.08;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          setTimeout(() => {
            o.stop();
            ctx.close();
          }, 70);
        } catch {}
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function moveNoButton() {
        const pad = 12;
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const rect = noBtn.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        const x = Math.random() * (vw - w - pad * 2) + pad;
        const y = Math.random() * (vh - h - pad * 2) + pad;

        noBtn.style.left = `${clamp(x, pad, vw - w - pad)}px`;
        noBtn.style.top = `${clamp(y, pad, vh - h - pad)}px`;
        ping();

        rejectCount += 1;
        const msg = CONFIG.tauntMessages[rejectCount % CONFIG.tauntMessages.length];
        showToast(msg);
      }

      function armNoButton() {
        noBtn.addEventListener("mouseenter", moveNoButton);
        noBtn.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            moveNoButton();
          },
          { passive: false }
        );
        noBtn.addEventListener("click", (e) => {
          e.preventDefault();
          moveNoButton();
        });
      }

      function showYesScreen() {
        screenAsk.style.display = "none";
        screenYes.style.display = "block";
        fw.style.display = "block";
        startFireworks();
        tryPlayMusic();
      }

      async function tryPlayMusic() {
        if (!CONFIG.bgmMp3Url) return;
        try {
          await bgm.play();
        } catch {}
      }

      let raf = null;
      function startFireworks() {
        cancelAnimationFrame(raf);
        const ctx = fw.getContext("2d");
        const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

        function resize() {
          fw.width = Math.floor(window.innerWidth * DPR);
          fw.height = Math.floor(window.innerHeight * DPR);
          fw.style.width = "100%";
          fw.style.height = "100%";
        }
        resize();
        window.addEventListener("resize", resize, { passive: true });

        const particles = [];
        const colors = ["#60a5fa", "#34d399", "#fbbf24", "#f472b6", "#a78bfa", "#fb7185"];

        function burst() {
          const cx = Math.random() * fw.width * 0.9 + fw.width * 0.05;
          const cy = Math.random() * fw.height * 0.45 + fw.height * 0.08;
          const count = 80 + Math.floor(Math.random() * 60);
          const color = colors[Math.floor(Math.random() * colors.length)];
          for (let i = 0; i < count; i++) {
            const a = Math.random() * Math.PI * 2;
            const sp = (1.5 + Math.random() * 3.2) * DPR;
            particles.push({
              x: cx,
              y: cy,
              vx: Math.cos(a) * sp,
              vy: Math.sin(a) * sp,
              life: 70 + Math.random() * 50,
              color,
              size: (1 + Math.random() * 2.2) * DPR,
            });
          }
        }

        let t = 0;
        function tick() {
          t += 1;
          ctx.fillStyle = "rgba(0,0,0,0.22)";
          ctx.fillRect(0, 0, fw.width, fw.height);

          if (t % 22 === 0) burst();

          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.vy += 0.03 * DPR;
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 1;
            p.vx *= 0.99;
            p.vy *= 0.99;

            ctx.fillStyle = p.color;
            ctx.globalAlpha = Math.max(0, Math.min(1, p.life / 100));
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;

            if (p.life <= 0) particles.splice(i, 1);
          }
          raf = requestAnimationFrame(tick);
        }
        tick();
      }

      function setupBackBlock() {
        history.pushState({ guard: true }, "", location.href);
        window.addEventListener("popstate", () => {
          if (allowExit) return;
          history.pushState({ guard: true }, "", location.href);
          openBlocker();
        });

        window.addEventListener("beforeunload", (e) => {
          if (allowExit) return;
          e.preventDefault();
          e.returnValue = "";
          return "";
        });
      }

      function openBlocker() {
        blocker.style.display = "grid";
      }
      function closeBlocker() {
        blocker.style.display = "none";
      }

      stayBtn.addEventListener("click", closeBlocker);
      okBtn.addEventListener("click", () => {
        allowExit = true;
        closeBlocker();
        showToast("Thôi được… nhưng quay lại trả lời nha!");
      });

      yesBtn.addEventListener("click", showYesScreen);
      replayBtn.addEventListener("click", () => {
        fw.style.display = "block";
        startFireworks();
        tryPlayMusic();
      });

      armNoButton();
      setupBackBlock();

      requestAnimationFrame(() => {
        const r = card.getBoundingClientRect();
        noBtn.style.left = `${r.left + r.width * 0.62}px`;
        noBtn.style.top = `${r.top + r.height * 0.72}px`;
      });
    </script>
  </body>
</html>

